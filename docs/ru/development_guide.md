# Руководство разработчика CardForge

Этот документ собран как «всё, что нужно геймдизайнеру и разработчику», чтобы быстро поднять и развивать карточного Telegram-бота на базе CardForge.

---

## 1. Архитектурные блоки

| Блок              | Назначение                                                                                     |
|-------------------|------------------------------------------------------------------------------------------------|
| `cardforge.app.BotApp`         | Объединяет конфигурацию, сторы, доменные сервисы, реестры и мини-игры.             |
| `cardforge.domain`             | Модели (карты, награды, экономика) и сервисы (инвентарь, игроки, события).          |
| `cardforge.storage`            | Хранилища состояния (in-memory, SQLAlchemy).                                        |
| `cardforge.loaders`            | Импорт карточных каталогов из JSON (будущие расширения: YAML, API).                 |
| `cardforge.telegram`           | Готовые aiogram-роутеры, фильтры, контекст мини-игр.                                |
| `cardforge.admin`              | Админ-команды и сервис выдачи/бана.                                                 |
| `cardforge.diagnostics`        | Симуляции экономики и чек-листы баланса.                                           |
| `cardforge.testing`            | Фабрики, фикстуры, тест-клиент.                                                     |

---

## 2. Конфигурация `CardForgeConfig`

| Поле                          | Тип                              | По умолчанию        | Описание                                                     |
|-------------------------------|----------------------------------|----------------------|--------------------------------------------------------------|
| `bot_token`                   | `str`                            | `""`                 | Токен Telegram-бота.                                         |
| `storage.backend`             | `"memory"`\|`"sqlalchemy"`       | `"memory"`           | Выбор хранилища.                                             |
| `storage.dsn`                 | `str \| None`                    | `None`               | DSN для SQLAlchemy.                                          |
| `admin.admin_ids`             | `set[int]`                       | `set()`              | Авторизованные ID админов.                                   |
| `admin.commands`              | `AdminCommandConfig`             | стандартные команды  | Переименование `/ban`, `/unban`, `/grantcard`, `/grantcurrency`. |
| `drop.base_cooldown_seconds`  | `int`                            | `3600`               | Кулдаун на дроп.                                             |
| `drop.allow_duplicates`       | `bool`                           | `True`               | Разрешены ли дубликаты.                                      |
| `drop.duplicate_penalty`      | `float`                          | `0.0`                | Доля награды, выдаваемая за дубликат.                        |
| `drop.max_cards_per_drop`     | `int`                            | `1`                  | Количество карт за один дроп.                                |
| `drop.rarity_weights`         | `dict[str, float]`               | `{}`                 | Глобальные веса редкостей.                                   |
| `default_currencies`          | `Sequence[str]`                  | `("coins","gems")`   | Валюты по умолчанию.                                         |
| `rng_seed`                    | `int \| None`                    | `None`               | Сид генератора случайных чисел для воспроизводимости.        |

> **Совет:** изменяйте `CardForgeConfig` до создания `BotApp`, чтобы избежать пересоздания сервисов.

---

## 3. JSON схема (детально)

### 3.1 Карты (`cards[]`)

| Поле          | Тип             | Обяз. | Комментарий                                             |
|---------------|-----------------|-------|---------------------------------------------------------|
| `id`          | `str`           | ✔     | Уникальный идентификатор.                               |
| `name`        | `str`           | ✔     | Отображаемое имя.                                       |
| `description` | `str`           | ✔     | Описание/лора.                                          |
| `rarity`      | `str`           | ✔     | `common`, `uncommon`, `rare`, `epic`, `legendary`.      |
| `maxCopies`   | `int`           | ✖     | Максимальное число копий (дубликаты после лимита).      |
| `weight`      | `float`         | ✖     | Базовый вес выпадения (по умолчанию 1.0).               |
| `reward`      | `object`        | ✖     | `currencies` + `experience`.                            |
| `image.url`   | `str` (URL)     | ✖     | Изображение для отправки пользователю.                  |
| `image.caption` | `str`         | ✖     | Подпись под изображением.                               |
| `tags`        | `array[str]`    | ✖     | Доп. признаки (фильтрация, коллекции).                  |

### 3.2 Паки (`packs[]`)

| Поле             | Тип               | Обяз. | Комментарий                                             |
|------------------|-------------------|-------|---------------------------------------------------------|
| `id`             | `str`             | ✔     | Уникальный идентификатор пака.                          |
| `name`           | `str`             | ✖     | Название пака.                                          |
| `cards`          | `array[str]`      | ✔     | Список `id` карточек.                                   |
| `allowDuplicates`| `bool`            | ✖     | Можно ли получать ту же карту снова.                    |
| `maxPerRoll`     | `int`             | ✖     | Сколько карт выдаётся за один дроп.                     |
| `cardWeights`    | `object`          | ✖     | Вес на конкретные карты.                                |
| `rarityWeights`  | `object`          | ✖     | Вес на редкости внутри пака.                            |

---

## 4. Алгоритм выпадения

1. Получаем список карт из пака.
2. Фильтруем по правилам дубликатов и `maxCopies`.
3. Рассчитываем веса (карта → пак → глобальные настройки).
4. Выбираем карты со взвешенной вероятностью (с повтором/без).
5. Начисляем награды или применяем стратегию дубликатов.

---

## 5. Duplicate Strategies

- `PenaltyDuplicateStrategy` — умножает награду карты на `duplicate_penalty`.
- `DustDuplicateStrategy(currency, amount)` — выдаёт фиксированную валюту.
- Свои стратегии: реализуйте интерфейс `DuplicateStrategy` и передайте в `BotApp`.

---

## 6. Мини-игры

`TelegramMiniGameContext` предоставляет:
- `send_message`
- `award_currency`
- `spend_currency`
- `grant_card`
- `grant_experience`
- `get_profile`
- `send_dice` — отправить эмодзи-кубик (или другой `emoji`) в Telegram.
- `roll_dice` — отправить кубик и получить выпавшее значение.

Команды мини-игр регистрируются автоматически через `MiniGame.command` и `aliases`. `MiniGameRegistry` проверяет конфликты команд.

---

## 7. Администрирование

`AdminService`:
- `ban_user`, `unban_user`
- `grant_currency`, `grant_card`
- `adjust_experience`, `set_cooldown`

Команды настраиваются через `AdminCommandConfig` или переменные `CARDFORGE_ADMIN_CMD_*`. Все действия пишутся в `AuditStore`.

---

## 8. Тестирование

- `tests/test_inventory.py`: выпадения, кулдауны, дубликаты.
- `tests/test_json_loader.py`: валидация JSON.
- `tests/test_player_service.py`: операции с игроком.
- Фикстуры и фабрики: `cardforge.testing`.
- `TestClient`: сценарные тесты без Telegram.

---

## 9. Диагностика и аналитика

| Утилита                                    | Описание                                         |
|-------------------------------------------|--------------------------------------------------|
| `cardforge-sim`                           | Симуляция выпадений и экономики.                 |
| `cardforge-check`                         | Чек-лист баланса.                                |
| `cardforge-validate --catalog`            | Проверка JSON каталога.                          |
| `cardforge-validate --module`             | Проверка собранного приложения.                  |
| `EventBus`                                | События `player.drop.completed`, `admin.*`.      |

---

## 10. Расширение фреймворка

- Новые стратегии дубликатов.
- Собственные хранилища (реализация протоколов).
- Альтернативные транспортные адаптеры (Pyrogram, Telethon).
- Дополнительные CLI и проверки.

---

## 11. Чек-лист разработки

1. Описать контент (карты, валюты, мини-игры).
2. Настроить экономику и стратегии дубликатов.
3. Подключить хранилище и роутеры.
4. Прогнать симуляции и валидации.
5. Написать и запустить тесты.
6. Подготовить к деплою (webhook/polling).

---

## 12. Куда «вкручиваться»

| Точка расширения                        | Как кастомизировать                                                                           |
|------------------------------------------|------------------------------------------------------------------------------------------------|
| `BotApp(duplicate_strategy=...)`         | Подставить собственную стратегию обработки дубликатов.                                        |
| `CardForgeConfig.drop`                   | Настроить кулдауны, веса редкостей, лимиты дропа.                                             |
| `cardforge.loaders.validate_catalog_*`   | Добавить свои проверки каталога до регистрации.                                               |
| `MiniGameRegistry.register`              | Подключать любые мини-игры с собственным контекстом.                                          |
| `AdminCommandConfig`                     | Переименовывать команды администрирования.                                                    |
| `EventBus.subscribe(...)`                | Реагировать на события (логирование, метрики, ачивки).                                        |
| `PlayerService`                          | Дополнять операции над кошельком, опытом, коллекцией.                                         |
| `InventoryService`                       | Передавать собственный `rng` или расширять логику выпадений.                                  |
| `cardforge.testing`                      | Создавать фабрики и сценарии для автотестов.                                                  |

Используйте эти точки, чтобы адаптировать ядро под вашу экономику и механику бота.
