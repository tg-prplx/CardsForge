# Обзор архитектуры CardForge

## Цели
- Ускорить прототипирование карточных Telegram-ботов.
- Предоставить гибкие доменные примитивы (карты, валюты, мини-игры), которые можно расширять и заменять.
- Дать инструменты для проверки экономики, администрирования и автоматизированного тестирования.
- Поддерживать разные бэкенды хранения, чтобы можно было подключить существующие базы данных.

## Структура проекта
```
cardforge/
├── app.py             # Управление жизненным циклом приложения
├── config.py          # Конфигурация и сборка зависимостей
├── registry.py        # Реестры карт, валют и мини-игр
├── loaders/           # Загрузчики декларативных каталогов (JSON и т.д.)
├── storage/           # Абстракции хранилищ (in-memory и SQLAlchemy)
├── domain/            # Доменные модели и сервисы
├── telegram/          # Интеграция с aiogram
├── admin/             # Админ-команды и сервисы
├── diagnostics/       # Диагностика экономики и симуляции
└── testing/           # Фикстуры и тест-клиент
```

### Доменный слой
- `domain/cards.py`: карточки, редкости, награды, правила дубликатов.
- `domain/economy.py`: валюты, кошельки и операции.
- `domain/inventory.py`: инвентарь игрока, кулдауны, выдача наград.
- `domain/events.py`: шина событий для мониторинга действий.
- `domain/drop_strategies.py`: стратегии обработки дубликатов (штрафы, пыль, свои варианты).
- `domain/player.py`: операции с профилем игрока, кошельком и опытом.

### Слой хранения
- `storage/base.py`: интерфейсы для состояний игрока, каталога и журналов.
- `storage/memory.py`: in-memory реализации для прототипов и тестов.
- `storage/sqlalchemy.py`: асинхронный бэкенд на SQLAlchemy (SQLite по умолчанию).

### Интеграция с Telegram
- `telegram/aiogram_router.py`: подключение команд и обработчиков aiogram.
- `telegram/filters.py`: фильтры для кулдаунов, банов и прав администратора.
- `telegram/keyboards.py`: готовые inline-клавиатуры.
- `telegram/minigames.py`: реализация контекста `MiniGame` для Telegram.

### Администрирование
- `admin/service.py`: бан/разбан, выдача карт и валют, корректировка опыта.
- `admin/commands.py`: набор aiogram-команд для админов.
- `admin/audit.py`: учёт действий в выбранном хранилище.

### Диагностика и тестирование
- `diagnostics/economy_simulator.py`: монте-карло симулятор выпадений и экономики.
- `diagnostics/checklist.py`: проверки на перекосы и недочёты экономики.
- `testing/factory.py`: фабрики карт и игроков.
- `testing/test_client.py`: тест-клиент для сценариев без Telegram.

## Точки расширения
- Декларативные реестры карт, валют и мини-игр (код или JSON-каталоги).
- Загрузчики JSON позволяют контент-команде обновлять данные без Python.
- Сервисные интерфейсы (`CardService`, `EconomyService`, `MiniGame`) облегчают DI.
- Middleware для aiogram позволяет подключать логи, аналитику, защиту.
- Гибкая конфигурация через переменные окружения, `.env` или код (включая переименование команд админа).

## Рабочий процесс
1. Описать карты, валюты и мини-игры через реестры или JSON.
2. Выбрать или реализовать хранилище.
3. Создать `BotApp` и запустить aiogram (polling или webhook).
4. Перед релизом прогнать диагностику и симуляции экономики.
5. В продакшене использовать админ-инструменты для правок и выдачи наград.

## Стратегия тестирования
- Pytest-фикстуры для in-memory хранилищ и детерминированных генераторов.
- Примеры тестов для выпадений, дубликатов и экономики.
- Сценарные тесты через `TestClient`, чтобы убедиться в корректной логике без Telegram.
